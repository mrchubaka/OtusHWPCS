#Домашнее задание №5

##Бэкапы Постгреса

###Делам бэкап Постгреса используя WAL-G

```
ostgres@alex-otus:/home/backups$ cat ~/.walg.json 
{
    "WALG_FILE_PREFIX": "/home/backups",
    "WALG_COMPRESSION_METHOD": "brotli",
    "WALG_DELTA_MAX_STEPS": "5",
    "PGDATA": "/var/lib/postgresql/14/main",
    "PGHOST": "/var/run/postgresql/.s.PGSQL.5432"
}
postgres@alex-otus:/home/backups$ 

postgres@alex-otus:~$ cat /var/lib/postgresql/14/main/postgresql.auto.conf
# Do not edit this file manually!
# It will be overwritten by the ALTER SYSTEM command.
wal_level=replica
archive_mode=on
archive_command='wal-g wal-push "%p" >> /var/lib/postgresql/14/main/log/archive_command.log 2>&1' 
archive_timeout=60
restore_command='wal-g wal-fetch "%f" "%p" >> /var/lib/postgresql/14/main/log/restore_command.log 2>&1' 
postgres@alex-otus:~$ 


postgres@alex-otus:~$ wal-g -v
wal-g version v2.0.1	b7d53dd	2022.08.25_09:34:20	PostgreSQL
postgres@alex-otus:~$ 

postgres@alex-otus:~$ 
postgres@alex-otus:~$ wal-g backup-push /var/lib/postgresql/14/main 
INFO: 2023/05/19 18:52:08.964369 Couldn't find previous backup. Doing full backup.
INFO: 2023/05/19 18:52:08.970671 Calling pg_start_backup()
INFO: 2023/05/19 18:52:09.128137 Starting a new tar bundle
INFO: 2023/05/19 18:52:09.128166 Walking ...
INFO: 2023/05/19 18:52:09.128413 Starting part 1 ...
INFO: 2023/05/19 18:52:09.492077 Packing ...
INFO: 2023/05/19 18:52:09.492670 Finished writing part 1.
INFO: 2023/05/19 18:52:09.492796 Starting part 2 ...
INFO: 2023/05/19 18:52:09.492830 /global/pg_control
INFO: 2023/05/19 18:52:09.493091 Finished writing part 2.
INFO: 2023/05/19 18:52:09.493140 Calling pg_stop_backup()
INFO: 2023/05/19 18:52:10.510555 Starting part 3 ...
INFO: 2023/05/19 18:52:10.510587 backup_label
INFO: 2023/05/19 18:52:10.510590 tablespace_map
INFO: 2023/05/19 18:52:10.510733 Finished writing part 3.
INFO: 2023/05/19 18:52:10.512781 Wrote backup with name base_000000010000000000000002
postgres@alex-otus:~$ 

postgres@alex-otus:~$ wal-g backup-list
name                          modified                  wal_segment_backup_start
base_000000010000000000000002 2023-05-19T18:52:10+03:00 000000010000000000000002
postgres@alex-otus:~$ psql alex -c "UPDATE test SET i = 3 WHERE i = 30"
UPDATE 1
postgres@alex-otus:~$ 
postgres@alex-otus:~$ psql alex -c "select * from test;"
 i  
----
 10
 20
  3
(3 rows)

postgres@alex-otus:~$ wal-g backup-push /var/lib/postgresql/14/main
INFO: 2023/05/19 18:54:52.494910 LATEST backup is: 'base_000000010000000000000002'
INFO: 2023/05/19 18:54:52.495243 Delta backup from base_000000010000000000000002 with LSN 0/2000028.
INFO: 2023/05/19 18:54:52.514226 Calling pg_start_backup()
INFO: 2023/05/19 18:54:52.604994 Delta backup enabled
INFO: 2023/05/19 18:54:52.605023 Starting a new tar bundle
INFO: 2023/05/19 18:54:52.605044 Walking ...
INFO: 2023/05/19 18:54:52.605275 Starting part 1 ...
INFO: 2023/05/19 18:54:52.617756 Packing ...
INFO: 2023/05/19 18:54:52.618755 Finished writing part 1.
INFO: 2023/05/19 18:54:52.618981 Starting part 2 ...
INFO: 2023/05/19 18:54:52.619683 /global/pg_control
INFO: 2023/05/19 18:54:52.619987 Finished writing part 2.
INFO: 2023/05/19 18:54:52.620085 Calling pg_stop_backup()
INFO: 2023/05/19 18:54:53.652768 Starting part 3 ...
INFO: 2023/05/19 18:54:53.652816 backup_label
INFO: 2023/05/19 18:54:53.652822 tablespace_map
INFO: 2023/05/19 18:54:53.653043 Finished writing part 3.
INFO: 2023/05/19 18:54:53.655142 Wrote backup with name base_000000010000000000000004_D_000000010000000000000002
postgres@alex-otus:~$ 
postgres@alex-otus:~$ wal-g backup-list
name                                                     modified                  wal_segment_backup_start
base_000000010000000000000002                            2023-05-19T18:52:10+03:00 000000010000000000000002
base_000000010000000000000004_D_000000010000000000000002 2023-05-19T18:54:53+03:00 000000010000000000000004
postgres@alex-otus:~$ 

postgres@alex-otus:~$ pg_createcluster 14 main2
Creating new PostgreSQL cluster 14/main2 ...
/usr/lib/postgresql/14/bin/initdb -D /var/lib/postgresql/14/main2 --auth-local peer --auth-host scram-sha-256 --no-instructions
The files belonging to this database system will be owned by user "postgres".
This user must also own the server process.

The database cluster will be initialized with locales
  COLLATE:  en_US.UTF-8
  CTYPE:    en_US.UTF-8
  MESSAGES: en_US.UTF-8
  MONETARY: ru_RU.UTF-8
  NUMERIC:  ru_RU.UTF-8
  TIME:     ru_RU.UTF-8
The default database encoding has accordingly been set to "UTF8".
The default text search configuration will be set to "english".

Data page checksums are disabled.

fixing permissions on existing directory /var/lib/postgresql/14/main2 ... ok
creating subdirectories ... ok
selecting dynamic shared memory implementation ... posix
selecting default max_connections ... 100
selecting default shared_buffers ... 128MB
selecting default time zone ... Europe/Moscow
creating configuration files ... ok
running bootstrap script ... ok
performing post-bootstrap initialization ... ok
syncing data to disk ... ok
Warning: systemd does not know about the new cluster yet. Operations like "service postgresql start" will not handle it. To fix, run:
  sudo systemctl daemon-reload
Ver Cluster Port Status Owner    Data directory               Log file
14  main2   5433 down   postgres /var/lib/postgresql/14/main2 /var/log/postgresql/postgresql-14-main2.log
postgres@alex-otus:~$ 
postgres@alex-otus:~$ rm -rf /var/lib/postgresql/14/main2
postgres@alex-otus:~$ wal-g backup-fetch /var/lib/postgresql/14/main2 LATEST
INFO: 2023/05/19 18:56:02.238523 Selecting the latest backup...
INFO: 2023/05/19 18:56:02.238795 LATEST backup is: 'base_000000010000000000000004_D_000000010000000000000002'
INFO: 2023/05/19 18:56:02.242800 Delta from base_000000010000000000000002 at LSN 0/2000028 
INFO: 2023/05/19 18:56:02.247885 Finished extraction of part_003.tar.br
INFO: 2023/05/19 18:56:03.092744 Finished extraction of part_001.tar.br
INFO: 2023/05/19 18:56:03.093041 Finished extraction of pg_control.tar.br
INFO: 2023/05/19 18:56:03.093070 
Backup extraction complete.
INFO: 2023/05/19 18:56:03.093088 base_000000010000000000000002 fetched. Upgrading from LSN 0/2000028 to LSN 0/4000028 
INFO: 2023/05/19 18:56:03.097909 Finished extraction of part_003.tar.br
INFO: 2023/05/19 18:56:03.100007 Finished extraction of part_001.tar.br
INFO: 2023/05/19 18:56:03.100766 Finished extraction of pg_control.tar.br
INFO: 2023/05/19 18:56:03.100881 
Backup extraction complete.
postgres@alex-otus:~$ touch "/var/lib/postgresql/14/main2/recovery.signal"
postgres@alex-otus:~$ pg_ctlcluster 14 main2 start

postgres@alex-otus:~$ psql -p 5433 alex -c "select * from test;"
 i  
----
 10
 20
  3
(3 rows)

postgres@alex-otus:~$ 


```

###Делам бэкап Постгреса используя pg_probackup и восстанавливаемся на другом кластере

```
alex@alex-otus:~/Desktop/pg_probackup-master$ sudo sh -c 'echo "deb [arch=amd64] https://repo.postgrespro.ru/pg_probackup/deb/ $(lsb_release -cs) main-$(lsb_release -cs)" > /etc/apt/sources.list.d/pg_probackup.list'
alex@alex-otus:~/Desktop/pg_probackup-master$ 
alex@alex-otus:~/Desktop/pg_probackup-master$ sudo wget -O - https://repo.postgrespro.ru/pg_probackup/keys/GPG-KEY-PG_PROBACKUP | sudo apt-key add - && sudo apt-get update

Redirecting output to ‘wget-log’.
Warning: apt-key is deprecated. Manage keyring files in trusted.gpg.d instead (see apt-key(8)).
OK
Hit:1 http://ru.archive.ubuntu.com/ubuntu jammy InRelease
Hit:2 http://ru.archive.ubuntu.com/ubuntu jammy-updates InRelease
Hit:3 http://ru.archive.ubuntu.com/ubuntu jammy-backports InRelease
Get:4 https://repo.postgrespro.ru/pg_probackup/deb jammy InRelease [3 354 B]
Hit:5 http://security.ubuntu.com/ubuntu jammy-security InRelease             
Get:6 https://repo.postgrespro.ru/pg_probackup/deb jammy/main-jammy amd64 Packages [1 696 B]
Fetched 5 050 B in 1s (8 278 B/s)
Reading package lists... Done
W: https://repo.postgrespro.ru/pg_probackup/deb/dists/jammy/InRelease: Key is stored in legacy trusted.gpg keyring (/etc/apt/trusted.gpg), see the DEPRECATION section in apt-key(8) for details.
alex@alex-otus:~/Desktop/pg_probackup-master$ sudo apt-get install pg-probackup-14
Reading package lists... Done
Building dependency tree... Done
Reading state information... Done
The following packages were automatically installed and are no longer required:
  libflashrom1 libftdi1-2 libllvm13
Use 'sudo apt autoremove' to remove them.
The following NEW packages will be installed:
  pg-probackup-14
0 upgraded, 1 newly installed, 0 to remove and 10 not upgraded.
Need to get 208 kB of archives.
After this operation, 502 kB of additional disk space will be used.
Get:1 https://repo.postgrespro.ru/pg_probackup/deb jammy/main-jammy amd64 pg-probackup-14 amd64 2.5.12-1.d6721662ec76257d9470b1d20d75b7bc6bb1501c.jammy [208 kB]
Fetched 208 kB in 0s (531 kB/s)     
Selecting previously unselected package pg-probackup-14.
(Reading database ... 189882 files and directories currently installed.)
Preparing to unpack .../pg-probackup-14_2.5.12-1.d6721662ec76257d9470b1d20d75b7bc6bb1501c.jammy_amd64.deb ...
Unpacking pg-probackup-14 (2.5.12-1.d6721662ec76257d9470b1d20d75b7bc6bb1501c.jammy) ...
Setting up pg-probackup-14 (2.5.12-1.d6721662ec76257d9470b1d20d75b7bc6bb1501c.jammy) ...
alex@alex-otus:~/Desktop/pg_probackup-master$ 
```

###Делам бэкап Постгреса используя pg_probackup и восстанавливаемся на другом кластере

```

postgres@alex-otus:~$ pg_probackup-14 
ERROR: No subcommand specified. Please run with "help" argument to see possible subcommands.
postgres@alex-otus:~$ echo "BACKUP_PATH=/home/backups_pg/">>~/.bashrc
echo "export BACKUP_PATH">>~/.bashrc
cd $HOME
postgres@alex-otus:~$ 
postgres@alex-otus:~$ cd ~
postgres@alex-otus:~$ . .bashrc
postgres@alex-otus:~$ echo $BACKUP_PATH
/home/backups_pg/
postgres@alex-otus:~$ psql
psql (14.7 (Ubuntu 14.7-0ubuntu0.22.04.1))
Type "help" for help.

postgres=# create user backup;
ALTER ROLE backup NOSUPERUSER;
ALTER ROLE backup WITH REPLICATION;
GRANT USAGE ON SCHEMA pg_catalog TO backup;
GRANT EXECUTE ON FUNCTION pg_catalog.current_setting(text) TO backup;
GRANT EXECUTE ON FUNCTION pg_catalog.pg_is_in_recovery() TO backup;
GRANT EXECUTE ON FUNCTION pg_catalog.pg_start_backup(text, boolean, boolean) TO backup;
GRANT EXECUTE ON FUNCTION pg_catalog.pg_stop_backup(boolean, boolean) TO backup;
GRANT EXECUTE ON FUNCTION pg_catalog.pg_create_restore_point(text) TO backup;
GRANT EXECUTE ON FUNCTION pg_catalog.pg_switch_wal() TO backup;
GRANT EXECUTE ON FUNCTION pg_catalog.pg_last_wal_replay_lsn() TO backup;
GRANT EXECUTE ON FUNCTION pg_catalog.txid_current() TO backup;
GRANT EXECUTE ON FUNCTION pg_catalog.txid_current_snapshot() TO backup;
GRANT EXECUTE ON FUNCTION pg_catalog.txid_snapshot_xmax(txid_snapshot) TO backup;
GRANT EXECUTE ON FUNCTION pg_catalog.pg_control_checkpoint() TO backup;
CREATE ROLE
ALTER ROLE
ALTER ROLE
GRANT
GRANT
GRANT
GRANT
GRANT
GRANT
GRANT
GRANT
GRANT
GRANT
GRANT
GRANT
postgres=# \q
postgres@alex-otus:~$ pg_probackup-14 init
INFO: Backup catalog '/home/backups_pg' successfully initialized
postgres@alex-otus:~$ cd $BACKUP_PATH
ls -l 
total 8
drwx------ 2 postgres postgres 4096 мая 19 20:11 backups
drwx------ 2 postgres postgres 4096 мая 19 20:11 wal
postgres@alex-otus:/home/backups_pg$ pg_probackup-14 add-instance --instance 'main' -D /var/lib/postgresql/14/main
INFO: Instance 'main' successfully initialized
postgres@alex-otus:/home/backups_pg$ psql -c "CREATE DATABASE alex2;"
CREATE DATABASE
postgres@alex-otus:/home/backups_pg$ psql alex2 -c "CREATE TABLE test(i int);"
psql alex2 -c "INSERT INTO test VALUES (10), (20), (30);"
psql alex2 -c "SELECT * FROM test;"
CREATE TABLE
INSERT 0 3
 i  
----
 10
 20
 30
(3 rows)

postgres@alex-otus:/home/backups_pg$ pg_probackup-14 show-config --instance main
# Backup instance information
pgdata = /var/lib/postgresql/14/main
system-identifier = 7233339124542898630
xlog-seg-size = 16777216
# Connection parameters
pgdatabase = postgres
# Replica parameters
replica-timeout = 5min
# Archive parameters
archive-timeout = 5min
# Logging parameters
log-level-console = INFO
log-level-file = OFF
log-format-console = PLAIN
log-format-file = PLAIN
log-filename = pg_probackup.log
log-rotation-size = 0TB
log-rotation-age = 0d
# Retention parameters
retention-redundancy = 0
retention-window = 0
wal-depth = 0
# Compression parameters
compress-algorithm = none
compress-level = 1
# Remote access parameters
remote-proto = ssh
postgres@alex-otus:/home/backups_pg$ pg_probackup-14 backup --instance 'main' -b FULL --stream --temp-slot
INFO: Backup start, pg_probackup version: 2.5.12, instance: main, backup ID: RUX150, backup mode: FULL, wal mode: STREAM, remote: false, compress-algorithm: none, compress-level: 1
WARNING: This PostgreSQL instance was initialized without data block checksums. pg_probackup have no way to detect data block corruption without them. Reinitialize PGDATA with option '--data-checksums'.
WARNING: Current PostgreSQL role is superuser. It is not recommended to run pg_probackup under superuser.
INFO: Database backup start
INFO: wait for pg_start_backup()
INFO: Wait for WAL segment /home/backups_pg/backups/main/RUX150/database/pg_wal/000000010000000000000009 to be streamed
INFO: PGDATA size: 42MB
INFO: Current Start LSN: 0/9000028, TLI: 1
INFO: Start transferring data files
INFO: Data files are transferred, time elapsed: 1s
INFO: wait for pg_stop_backup()
INFO: pg_stop backup() successfully executed
INFO: stop_lsn: 0/90020D0
INFO: Getting the Recovery Time from WAL
INFO: Syncing backup files to disk
INFO: Backup files are synced, time elapsed: 1s
INFO: Validating backup RUX150
INFO: Backup RUX150 data files are valid
INFO: Backup RUX150 resident size: 58MB
INFO: Backup RUX150 completed
postgres@alex-otus:/home/backups_pg$ pg_ctlcluster 14 main stop
postgres@alex-otus:/home/backups_pg$ /usr/lib/postgresql/14/bin/pg_checksums -D /var/lib/postgresql/14/main --enable
Checksum operation completed
Files scanned:  1517
Blocks scanned: 5330
pg_checksums: syncing data directory
pg_checksums: updating control file
Checksums enabled in cluster
postgres@alex-otus:/home/backups_pg$ pg_ctlcluster 14 main start

pg_lsclusters
Warning: the cluster will not be running as a systemd service. Consider using systemctl:
  sudo systemctl start postgresql@14-main
Ver Cluster Port Status Owner    Data directory               Log file
14  main    5432 online postgres /var/lib/postgresql/14/main  /var/log/postgresql/postgresql-14-main.log
14  main2   5433 online postgres /var/lib/postgresql/14/main2 /var/log/postgresql/postgresql-14-main2.log
postgres@alex-otus:/home/backups_pg$ pg_ctlcluster 14 main stop
postgres@alex-otus:/home/backups_pg$ /usr/lib/postgresql/14/bin/pg_checksums -D /var/lib/postgresql/14/main --enable
pg_checksums: error: data checksums are already enabled in cluster
postgres@alex-otus:/home/backups_pg$ pg_ctlcluster 14 main start
Warning: the cluster will not be running as a systemd service. Consider using systemctl:
  sudo systemctl start postgresql@14-main
postgres@alex-otus:/home/backups_pg$ pg_lsclusters
Ver Cluster Port Status Owner    Data directory               Log file
14  main    5432 online postgres /var/lib/postgresql/14/main  /var/log/postgresql/postgresql-14-main.log
14  main2   5433 online postgres /var/lib/postgresql/14/main2 /var/log/postgresql/postgresql-14-main2.log
postgres@alex-otus:/home/backups_pg$ pg_probackup-14 show

BACKUP INSTANCE 'main'
================================================================================================================================
 Instance  Version  ID      Recovery Time           Mode  WAL Mode  TLI  Time  Data   WAL  Zratio  Start LSN  Stop LSN   Status 
================================================================================================================================
 main      14       RUX150  2023-05-19 20:12:38+03  FULL  STREAM    1/0   11s  42MB  16MB    1,00  0/9000028  0/90020D0  OK     
postgres@alex-otus:/home/backups_pg$ psql alex2 -c "insert into test values (4);"
INSERT 0 1
postgres@alex-otus:/home/backups_pg$ pg_probackup-14 backup --instance 'main' -b DELTA --stream --temp-slot -U backup 
INFO: Backup start, pg_probackup version: 2.5.12, instance: main, backup ID: RUX18L, backup mode: DELTA, wal mode: STREAM, remote: false, compress-algorithm: none, compress-level: 1
ERROR: could not connect to database postgres: connection to server on socket "/var/run/postgresql/.s.PGSQL.5432" failed: FATAL:  Peer authentication failed for user "backup"

WARNING: Backup RUX18L is running, setting its status to ERROR
postgres@alex-otus:/home/backups_pg$ psql -c "ALTER USER backup PASSWORD 'alex2123';"
ALTER ROLE
postgres@alex-otus:/home/backups_pg$ pg_probackup-14 backup --instance 'main' -b DELTA --stream --temp-slot -h localhost -U backup -W
INFO: Backup start, pg_probackup version: 2.5.12, instance: main, backup ID: RUX190, backup mode: DELTA, wal mode: STREAM, remote: false, compress-algorithm: none, compress-level: 1
Password for user backup: 
ERROR: could not connect to database postgres: connection to server at "localhost" (127.0.0.1), port 5432 failed: FATAL:  password authentication failed for user "backup"
connection to server at "localhost" (127.0.0.1), port 5432 failed: FATAL:  password authentication failed for user "backup"

WARNING: Backup RUX190 is running, setting its status to ERROR
postgres@alex-otus:/home/backups_pg$ pg_probackup-14 backup --instance 'main' -b DELTA --stream --temp-slot -h localhost -U backup -W
INFO: Backup start, pg_probackup version: 2.5.12, instance: main, backup ID: RUX1BC, backup mode: DELTA, wal mode: STREAM, remote: false, compress-algorithm: none, compress-level: 1
Password for user backup: 
INFO: This PostgreSQL instance was initialized with data block checksums. Data block corruption will be detected
INFO: Database backup start
INFO: wait for pg_start_backup()
WARNING: Backup RUX190 has status: ERROR. Cannot be a parent.
WARNING: Backup RUX18L has status: ERROR. Cannot be a parent.
INFO: Parent backup: RUX150
INFO: Wait for WAL segment /home/backups_pg/backups/main/RUX1BC/database/pg_wal/00000001000000000000000D to be streamed
INFO: PGDATA size: 42MB
INFO: Current Start LSN: 0/D000028, TLI: 1
INFO: Parent Start LSN: 0/9000028, TLI: 1
INFO: Start transferring data files
INFO: Data files are transferred, time elapsed: 0
INFO: wait for pg_stop_backup()
INFO: pg_stop backup() successfully executed
INFO: stop_lsn: 0/D0001A0
INFO: Getting the Recovery Time from WAL
INFO: Syncing backup files to disk
INFO: Backup files are synced, time elapsed: 0
INFO: Validating backup RUX1BC
INFO: Backup RUX1BC data files are valid
INFO: Backup RUX1BC resident size: 22MB
INFO: Backup RUX1BC completed
postgres@alex-otus:/home/backups_pg$ 
postgres@alex-otus:/home/backups_pg$ 
postgres@alex-otus:/home/backups_pg$ rm ~/.pgpass
rm: cannot remove '/var/lib/postgresql/.pgpass': No such file or directory
postgres@alex-otus:/home/backups_pg$ echo "localhost:5432:alex2:backup:alex2123">>~/.pgpass
postgres@alex-otus:/home/backups_pg$ chmod 600 ~/.pgpass
postgres@alex-otus:/home/backups_pg$ pg_probackup-14 backup --instance 'main' -b DELTA --stream --temp-slot -h localhost -U backup --pgdatabase=alex2
INFO: Backup start, pg_probackup version: 2.5.12, instance: main, backup ID: RUX1CR, backup mode: DELTA, wal mode: STREAM, remote: false, compress-algorithm: none, compress-level: 1
INFO: This PostgreSQL instance was initialized with data block checksums. Data block corruption will be detected
INFO: Database backup start
INFO: wait for pg_start_backup()
ERROR: query failed: ERROR:  permission denied for function pg_start_backup
query was: SELECT pg_catalog.pg_start_backup($1, $2, false)
WARNING: Backup RUX1CR is running, setting its status to ERROR
postgres@alex-otus:/home/backups_pg$ nano /etc/postgresql/14/main/pg_hba.conf
postgres@alex-otus:/home/backups_pg$ 

postgres@alex-otus:/home/backups_pg$ psql -d alex2
psql (14.7 (Ubuntu 14.7-0ubuntu0.22.04.1))
Type "help" for help.

alex2=# BEGIN;
GRANT USAGE ON SCHEMA pg_catalog TO backup;
GRANT EXECUTE ON FUNCTION pg_catalog.current_setting(text) TO backup;
GRANT EXECUTE ON FUNCTION pg_catalog.set_config(text, text, boolean) TO backup;
GRANT EXECUTE ON FUNCTION pg_catalog.pg_is_in_recovery() TO backup;
GRANT EXECUTE ON FUNCTION pg_catalog.pg_start_backup(text, boolean, boolean) TO backup;
GRANT EXECUTE ON FUNCTION pg_catalog.pg_stop_backup(boolean,boolean) TO backup;
GRANT EXECUTE ON FUNCTION pg_catalog.pg_create_restore_point(text) TO backup;
GRANT EXECUTE ON FUNCTION pg_catalog.pg_switch_wal() TO backup;
GRANT EXECUTE ON FUNCTION pg_catalog.pg_last_wal_replay_lsn() TO backup;
GRANT EXECUTE ON FUNCTION pg_catalog.txid_current() TO backup;
GRANT EXECUTE ON FUNCTION pg_catalog.txid_current_snapshot() TO backup;
GRANT EXECUTE ON FUNCTION pg_catalog.txid_snapshot_xmax(txid_snapshot) TO backup;
GRANT EXECUTE ON FUNCTION pg_catalog.pg_control_checkpoint() TO backup;
COMMIT;
BEGIN
GRANT
GRANT
GRANT
GRANT
GRANT
GRANT
GRANT
GRANT
GRANT
GRANT
GRANT
GRANT
GRANT
COMMIT
alex2=# \q
postgres@alex-otus:/home/backups_pg$ 
postgres@alex-otus:/home/backups_pg$ pg_probackup-14 backup --instance 'main' -b DELTA --stream --temp-slot -h localhost -U backup --pgdatabase=alex2
INFO: Backup start, pg_probackup version: 2.5.12, instance: main, backup ID: RUX21K, backup mode: DELTA, wal mode: STREAM, remote: false, compress-algorithm: none, compress-level: 1
INFO: This PostgreSQL instance was initialized with data block checksums. Data block corruption will be detected
INFO: Database backup start
INFO: wait for pg_start_backup()
WARNING: Backup RUX1YH has status: ERROR. Cannot be a parent.
WARNING: Backup RUX1CR has status: ERROR. Cannot be a parent.
INFO: Parent backup: RUX1BC
Password for user backup: 
INFO: Wait for WAL segment /home/backups_pg/backups/main/RUX21K/database/pg_wal/000000010000000000000017 to be streamed
INFO: PGDATA size: 42MB
INFO: Current Start LSN: 0/17000028, TLI: 1
INFO: Parent Start LSN: 0/D000028, TLI: 1
INFO: Start transferring data files
INFO: Data files are transferred, time elapsed: 0
INFO: wait for pg_stop_backup()
INFO: pg_stop backup() successfully executed
INFO: stop_lsn: 0/17014118
INFO: Getting the Recovery Time from WAL
INFO: Syncing backup files to disk
INFO: Backup files are synced, time elapsed: 0
INFO: Validating backup RUX21K
INFO: Backup RUX21K data files are valid
INFO: Backup RUX21K resident size: 32MB
INFO: Backup RUX21K completed
postgres@alex-otus:/home/backups_pg$ pg_probackup-14 show

BACKUP INSTANCE 'main'
=====================================================================================================================================
 Instance  Version  ID      Recovery Time           Mode   WAL Mode  TLI  Time    Data   WAL  Zratio  Start LSN   Stop LSN    Status 
=====================================================================================================================================
 main      14       RUX21K  2023-05-19 20:32:43+03  DELTA  STREAM    1/1   44s   424kB  32MB    1,00  0/17000028  0/17014118  OK     
 main      14       RUX1BC  2023-05-19 20:16:32+03  DELTA  STREAM    1/1   17s  6527kB  16MB    1,00  0/D000028   0/D0001A0   OK     
 main      14       RUX150  2023-05-19 20:12:38+03  FULL   STREAM    1/0   11s    42MB  16MB    1,00  0/9000028   0/90020D0   OK     
postgres@alex-otus:/home/backups_pg$ pg_probackup-14 backup --instance 'main' -b DELTA --stream --temp-slot -h localhost -U backup -d alex2 -p 5432
INFO: Backup start, pg_probackup version: 2.5.12, instance: main, backup ID: RUX23H, backup mode: DELTA, wal mode: STREAM, remote: false, compress-algorithm: none, compress-level: 1
INFO: This PostgreSQL instance was initialized with data block checksums. Data block corruption will be detected
INFO: Database backup start
INFO: wait for pg_start_backup()
INFO: Parent backup: RUX21K
Password for user backup: 
INFO: Wait for WAL segment /home/backups_pg/backups/main/RUX23H/database/pg_wal/000000010000000000000019 to be streamed
INFO: PGDATA size: 42MB
INFO: Current Start LSN: 0/19000028, TLI: 1
INFO: Parent Start LSN: 0/17000028, TLI: 1
INFO: Start transferring data files
INFO: Data files are transferred, time elapsed: 0
INFO: wait for pg_stop_backup()
INFO: pg_stop backup() successfully executed
INFO: stop_lsn: 0/190001A0
INFO: Getting the Recovery Time from WAL
INFO: Syncing backup files to disk
INFO: Backup files are synced, time elapsed: 1s
INFO: Validating backup RUX23H
INFO: Backup RUX23H data files are valid
INFO: Backup RUX23H resident size: 38MB
INFO: Backup RUX23H completed
postgres@alex-otus:/home/backups_pg$ 
postgres@alex-otus:/home/backups_pg$ pg_probackup-14 show

BACKUP INSTANCE 'main'
=====================================================================================================================================
 Instance  Version  ID      Recovery Time           Mode   WAL Mode  TLI  Time    Data   WAL  Zratio  Start LSN   Stop LSN    Status 
=====================================================================================================================================
 main      14       RUX23H  2023-05-19 20:33:37+03  DELTA  STREAM    1/1   28s  6519kB  32MB    1,00  0/19000028  0/190001A0  OK     
 main      14       RUX21K  2023-05-19 20:32:43+03  DELTA  STREAM    1/1   44s   424kB  32MB    1,00  0/17000028  0/17014118  OK     
 main      14       RUX1BC  2023-05-19 20:16:32+03  DELTA  STREAM    1/1   17s  6527kB  16MB    1,00  0/D000028   0/D0001A0   OK     
 main      14       RUX150  2023-05-19 20:12:38+03  FULL   STREAM    1/0   11s    42MB  16MB    1,00  0/9000028   0/90020D0   OK     
postgres@alex-otus:/home/backups_pg$ cat ~/.pgpass
localhost:5432:alex2:backup:alex2123
postgres@alex-otus:/home/backups_pg$ psql -U backup -h localhost -p 5432
Password for user backup: 
psql: error: connection to server at "localhost" (127.0.0.1), port 5432 failed: FATAL:  database "backup" does not exist
postgres@alex-otus:/home/backups_pg$ psql -d alex2 -U backup -h localhost -p 5432
psql (14.7 (Ubuntu 14.7-0ubuntu0.22.04.1))
SSL connection (protocol: TLSv1.3, cipher: TLS_AES_256_GCM_SHA384, bits: 256, compression: off)
Type "help" for help.

alex2=> \q
postgres@alex-otus:/home/backups_pg$ pg_probackup-14 backup --instance 'main' -b FULL --stream -d alex2 -U backup -h localhost -p 5432
INFO: Backup start, pg_probackup version: 2.5.12, instance: main, backup ID: RUX25W, backup mode: FULL, wal mode: STREAM, remote: false, compress-algorithm: none, compress-level: 1
INFO: This PostgreSQL instance was initialized with data block checksums. Data block corruption will be detected
INFO: Database backup start
INFO: wait for pg_start_backup()
Password for user backup: 
INFO: Wait for WAL segment /home/backups_pg/backups/main/RUX25W/database/pg_wal/00000001000000000000001B to be streamed
INFO: PGDATA size: 42MB
INFO: Current Start LSN: 0/1B000028, TLI: 1
INFO: Start transferring data files
INFO: Data files are transferred, time elapsed: 0
INFO: wait for pg_stop_backup()
INFO: pg_stop backup() successfully executed
INFO: stop_lsn: 0/1B0001A0
INFO: Getting the Recovery Time from WAL
INFO: Syncing backup files to disk
INFO: Backup files are synced, time elapsed: 1s
INFO: Validating backup RUX25W
INFO: Backup RUX25W data files are valid
INFO: Backup RUX25W resident size: 58MB
INFO: Backup RUX25W completed
postgres@alex-otus:/home/backups_pg$ 
postgres@alex-otus:/home/backups_pg$ pg_probackup-14 show

BACKUP INSTANCE 'main'
=====================================================================================================================================
 Instance  Version  ID      Recovery Time           Mode   WAL Mode  TLI  Time    Data   WAL  Zratio  Start LSN   Stop LSN    Status 
=====================================================================================================================================
 main      14       RUX2FD  2023-05-19 20:40:26+03  FULL   STREAM    1/0    8s    42MB  32MB    1,00  0/1D000028  0/1D000168  OK     
 main      14       RUX25W  2023-05-19 20:34:55+03  FULL   STREAM    1/0   21s    42MB  16MB    1,00  0/1B000028  0/1B0001A0  OK     
 main      14       RUX23H  2023-05-19 20:33:37+03  DELTA  STREAM    1/1   28s  6519kB  32MB    1,00  0/19000028  0/190001A0  OK     
 main      14       RUX21K  2023-05-19 20:32:43+03  DELTA  STREAM    1/1   44s   424kB  32MB    1,00  0/17000028  0/17014118  OK     
 main      14       RUX1BC  2023-05-19 20:16:32+03  DELTA  STREAM    1/1   17s  6527kB  16MB    1,00  0/D000028   0/D0001A0   OK     
 main      14       RUX150  2023-05-19 20:12:38+03  FULL   STREAM    1/0   11s    42MB  16MB    1,00  0/9000028   0/90020D0   OK     
postgres@alex-otus:/home/backups_pg$ 
postgres@alex-otus:/home/backups_pg$ 
postgres@alex-otus:/home/backups_pg$ 
postgres@alex-otus:/home/backups_pg$ psql -U backup -h localhost -p 5432
Password for user backup: 
psql: error: connection to server at "localhost" (127.0.0.1), port 5432 failed: FATAL:  database "backup" does not exist
postgres@alex-otus:/home/backups_pg$ 
postgres@alex-otus:/home/backups_pg$ ls -al /var/lib/postgresql/14/
total 16
drwxr-xr-x  4 postgres postgres 4096 мая 19 18:56 .
drwxr-xr-x  4 postgres postgres 4096 мая 19 20:26 ..
drwx------ 20 postgres postgres 4096 мая 19 20:13 main
drwx------ 20 postgres postgres 4096 мая 19 18:56 main2
postgres@alex-otus:/home/backups_pg$ pg_createcluster 14 main3
Creating new PostgreSQL cluster 14/main3 ...
/usr/lib/postgresql/14/bin/initdb -D /var/lib/postgresql/14/main3 --auth-local peer --auth-host scram-sha-256 --no-instructions
The files belonging to this database system will be owned by user "postgres".
This user must also own the server process.

The database cluster will be initialized with locales
  COLLATE:  en_US.UTF-8
  CTYPE:    en_US.UTF-8
  MESSAGES: en_US.UTF-8
  MONETARY: ru_RU.UTF-8
  NUMERIC:  ru_RU.UTF-8
  TIME:     ru_RU.UTF-8
The default database encoding has accordingly been set to "UTF8".
The default text search configuration will be set to "english".

Data page checksums are disabled.

fixing permissions on existing directory /var/lib/postgresql/14/main3 ... ok
creating subdirectories ... ok
selecting dynamic shared memory implementation ... posix
selecting default max_connections ... 100
selecting default shared_buffers ... 128MB
selecting default time zone ... Europe/Moscow
creating configuration files ... ok
running bootstrap script ... ok
performing post-bootstrap initialization ... ok
syncing data to disk ... ok
Warning: systemd does not know about the new cluster yet. Operations like "service postgresql start" will not handle it. To fix, run:
  sudo systemctl daemon-reload
Ver Cluster Port Status Owner    Data directory               Log file
14  main3   5434 down   postgres /var/lib/postgresql/14/main3 /var/log/postgresql/postgresql-14-main3.log
postgres@alex-otus:/home/backups_pg$ rm -rf /var/lib/postgresql/14/main3
postgres@alex-otus:/home/backups_pg$ pg_probackup-14 restore --instance 'main' -i 'RUV8QY' -D /var/lib/postgresql/14/main3 
ERROR: Requested backup RUV8QY is not found.
postgres@alex-otus:/home/backups_pg$ pg_probackup-14 restore --instance 'main' -i 'RUX25W' -D /var/lib/postgresql/14/main3 
INFO: Validating backup RUX25W
INFO: Backup RUX25W data files are valid
INFO: Backup RUX25W WAL segments are valid
INFO: Backup RUX25W is valid.
INFO: Restoring the database from backup at 2023-05-19 20:34:44+03
INFO: Start restoring backup files. PGDATA size: 58MB
INFO: Backup files are restored. Transfered bytes: 58MB, time elapsed: 0
INFO: Restore incremental ratio (less is better): 100% (58MB/58MB)
INFO: Syncing restored files to disk
INFO: Restored backup files are synced, time elapsed: 1s
INFO: Restore of backup RUX25W completed.
postgres@alex-otus:/home/backups_pg$ 
postgres@alex-otus:/home/backups_pg$ pg_ctlcluster 14 main3 start
Warning: the cluster will not be running as a systemd service. Consider using systemctl:
  sudo systemctl start postgresql@14-main3
postgres@alex-otus:/home/backups_pg$ 
postgres@alex-otus:/home/backups_pg$ psql alex2 -p 5434 -c 'select * from test;'
 i  
----
 10
 20
 30
  4
(4 rows)

postgres@alex-otus:/home/backups_pg$ 
postgres@alex-otus:/home/backups_pg$ 
```

###Задание повышенной сложности*
###Под нагрузкой*

####Screen-1 // Создаем нагрузку
```
postgres@alex-otus:~$ date 
Пн 22 мая 2023 08:31:09 MSK
postgres@alex-otus:~$ pgbench -h localhost -p 5432 -U backup -T 60 -c 10 -j 2 -s 10 alex2
pgbench (14.7 (Ubuntu 14.7-0ubuntu0.22.04.1))
pgbench: warning: scale option ignored, using count from pgbench_branches table (1)
starting vacuum...end.
transaction type: <builtin: TPC-B (sort of)>
scaling factor: 1
query mode: simple
number of clients: 10
number of threads: 2
duration: 60 s
number of transactions actually processed: 110082
latency average = 5.444 ms
initial connection time = 94.122 ms
tps = 1837.043363 (without initial connection time)
postgres@alex-otus:~$ date
Пн 22 мая 2023 08:32:30 MSK
postgres@alex-otus:~$ 
```

####Screen-2 // Делаем бэкап
```
postgres@alex-otus:/home/backups_pg$ date
Пн 22 мая 2023 08:31:14 MSK
postgres@alex-otus:/home/backups_pg$ 
postgres@alex-otus:/home/backups_pg$ pg_probackup-14 backup --instance 'main' -b FULL --stream
INFO: Backup start, pg_probackup version: 2.5.12, instance: main, backup ID: RV1OO8, backup mode: FULL, wal mode: STREAM, remote: false, compress-algorithm: none, compress-level: 1
INFO: This PostgreSQL instance was initialized with data block checksums. Data block corruption will be detected
WARNING: Current PostgreSQL role is superuser. It is not recommended to run pg_probackup under superuser.
INFO: Database backup start
INFO: wait for pg_start_backup()
INFO: Wait for WAL segment /home/backups_pg/backups/main/RV1OO8/database/pg_wal/000000010000000000000037 to be streamed
INFO: PGDATA size: 81MB
INFO: Current Start LSN: 0/370001F8, TLI: 1
INFO: Start transferring data files
INFO: Data files are transferred, time elapsed: 0
INFO: wait for pg_stop_backup()
INFO: pg_stop backup() successfully executed
INFO: stop_lsn: 0/37C37228
INFO: Getting the Recovery Time from WAL
INFO: Syncing backup files to disk
INFO: Backup files are synced, time elapsed: 1s
INFO: Validating backup RV1OO8
INFO: Backup RV1OO8 data files are valid
INFO: Backup RV1OO8 resident size: 113MB
INFO: Backup RV1OO8 completed
postgres@alex-otus:/home/backups_pg$ pg_probackup-14 show --instance 'main' -i RV1OO8
#Configuration
backup-mode = FULL
stream = true
compress-alg = none
compress-level = 1
from-replica = false

#Compatibility
block-size = 8192
xlog-block-size = 8192
checksum-version = 1
program-version = 2.5.12
server-version = 14

#Result backup info
timelineid = 1
start-lsn = 0/370001F8
stop-lsn = 0/37C37228
start-time = '2023-05-22 08:31:20+03'
end-time = '2023-05-22 08:31:23+03'
recovery-xid = 234046
recovery-time = '2023-05-22 08:31:21+03'
data-bytes = 85424598
wal-bytes = 33554432
uncompressed-bytes = 85348054
pgdata-bytes = 85347699
status = OK
primary_conninfo = 'user=postgres channel_binding=prefer port=5432 sslmode=prefer sslcompression=0 sslsni=1 ssl_min_protocol_version=TLSv1.2 gssencmode=prefer krbsrvname=postgres target_session_attrs=any'
content-crc = 4063834735
postgres@alex-otus:/home/backups_pg$ date
Пн 22 мая 2023 08:32:27 MSK
postgres@alex-otus:/home/backups_pg$ 

```

###Бэкап снимаем с реплики**

```
В процессе.
```
